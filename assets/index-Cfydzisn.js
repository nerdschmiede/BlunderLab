var Zi=Object.defineProperty;var Xi=(e,t,n)=>t in e?Zi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var O=(e,t,n)=>Xi(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const Ji=["white","black"],bt=["a","b","c","d","e","f","g","h"],_t=["1","2","3","4","5","6","7","8"],eo=[..._t].reverse(),rn=Array.prototype.concat(...bt.map(e=>_t.map(t=>e+t))),ie=e=>rn[8*e[0]+e[1]],D=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Jn=rn.map(D);function to(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const no=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},on=e=>e==="white"?"black":"white",rt=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},Yt=(e,t)=>e.role===t.role&&e.color===t.color,at=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],ce=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},er=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},sn=(e,t)=>{e.style.visibility=t?"visible":"hidden"},Fe=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},tr=e=>e.button===2,ge=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function nr(e,t,n){const r=D(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const qe=(e,t)=>Math.abs(e-t),ro=e=>(t,n,r,i)=>qe(t,r)<2&&(e==="white"?i===n+1||n<=1&&i===n+2&&t===r:i===n-1||n>=6&&i===n-2&&t===r),rr=(e,t,n,r)=>{const i=qe(e,n),o=qe(t,r);return i===1&&o===2||i===2&&o===1},ir=(e,t,n,r)=>qe(e,n)===qe(t,r),or=(e,t,n,r)=>e===n||t===r,sr=(e,t,n,r)=>ir(e,t,n,r)||or(e,t,n,r),io=(e,t,n)=>(r,i,o,s)=>qe(r,o)<2&&qe(i,s)<2||n&&i===s&&i===(e==="white"?0:7)&&(r===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function oo(e,t){const n=t==="white"?"1":"8",r=[];for(const[i,o]of e)i[1]===n&&o.color===t&&o.role==="rook"&&r.push(D(i)[0]);return r}function ar(e,t,n){const r=e.get(t);if(!r)return[];const i=D(t),o=r.role,s=o==="pawn"?ro(r.color):o==="knight"?rr:o==="bishop"?ir:o==="rook"?or:o==="queen"?sr:io(r.color,oo(e,r.color),n);return Jn.filter(a=>(i[0]!==a[0]||i[1]!==a[1])&&s(i[0],i[1],a[0],a[1])).map(ie)}function V(e,...t){e&&setTimeout(()=>e(...t),1)}function so(e){e.orientation=on(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function ao(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}function lo(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=n)}function co(e,t,n,r){Te(e),e.premovable.current=[t,n],V(e.premovable.events.set,t,n,r)}function $e(e){e.premovable.current&&(e.premovable.current=void 0,V(e.premovable.events.unset))}function uo(e,t,n){$e(e),e.predroppable.current={role:t,key:n},V(e.predroppable.events.set,t,n)}function Te(e){const t=e.predroppable;t.current&&(t.current=void 0,V(t.events.unset))}function fo(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const i=D(t),o=D(n);if(i[1]!==0&&i[1]!==7||i[1]!==o[1])return!1;i[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=ie([7,o[1]]):o[0]===2&&(n=ie([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),i[0]<o[0]?(e.pieces.set(ie([6,o[1]]),r),e.pieces.set(ie([5,o[1]]),s)):(e.pieces.set(ie([2,o[1]]),r),e.pieces.set(ie([3,o[1]]),s)),!0)}function lr(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!r)return!1;const o=i&&i.color!==r.color?i:void 0;return n===e.selected&&oe(e),V(e.events.move,t,n,o),fo(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,V(e.events.change),o||!0}function an(e,t,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return V(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,V(e.events.change),e.movable.dests=void 0,e.turnColor=on(e.turnColor),!0}function cr(e,t,n){const r=lr(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=on(e.turnColor),e.animation.current=void 0),r}function ur(e,t,n){if(ln(e,t,n)){const r=cr(e,t,n);if(r){const i=e.hold.stop();oe(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return r!==!0&&(o.captured=r),V(e.movable.events.after,t,n,o),!0}}else if(po(e,t,n))return co(e,t,n,{ctrlKey:e.stats.ctrlKey}),oe(e),!0;return oe(e),!1}function fr(e,t,n,r){const i=e.pieces.get(t);i&&(ho(e,t,n)||r)?(e.pieces.delete(t),an(e,i,n,r),V(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&go(e,t,n)?uo(e,i.role,n):($e(e),Te(e)),e.pieces.delete(t),oe(e)}function Zt(e,t,n){if(V(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){oe(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&ur(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(hr(e,t)||cn(e,t))&&(dr(e,t),e.hold.start())}function dr(e,t){e.selected=t,cn(e,t)?e.premovable.customDests||(e.premovable.dests=ar(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function oe(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function hr(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const ln=(e,t,n)=>{var r,i;return t!==n&&hr(e,t)&&(e.movable.free||!!(!((i=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||i===void 0)&&i.includes(n)))};function ho(e,t,n){const r=e.pieces.get(t);return!!r&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function cn(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function po(e,t,n){var r,i;const o=(i=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(t))!==null&&i!==void 0?i:ar(e.pieces,t,e.premovable.castle);return t!==n&&cn(e,t)&&o.includes(n)}function go(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);return!!r&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function mo(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function vo(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let i=!1;if(ln(e,n,r)){const o=cr(e,n,r);if(o){const s={premove:!0};o!==!0&&(s.captured=o),V(e.movable.events.after,n,r,s),i=!0}}return $e(e),i}function bo(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;if(t(n)){const i={role:n.role,color:e.movable.color};an(e,i,n.key)&&(V(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return Te(e),r}function un(e){$e(e),Te(e),oe(e)}function qn(e){e.movable.color=e.movable.dests=e.animation.current=void 0,un(e)}function Be(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),r>=0&&r<8&&i>=0&&i<8?ie([r,i]):void 0}function _o(e,t,n,r){const i=D(e),o=Jn.filter(c=>sr(i[0],i[1],c[0],c[1])||rr(i[0],i[1],c[0],c[1])),a=o.map(c=>nr(ie(c),n,r)).map(c=>rt(t,c)),[,l]=a.reduce((c,p,g)=>c[0]<p?c:[p,g],[a[0],0]);return ie(o[l])}const Y=e=>e.orientation==="white",pr="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",yo={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},wo={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function gr(e){e==="start"&&(e=pr);const t=new Map;let n=7,r=0;for(const i of e)switch(i){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const o=t.get(ie([r-1,n]));o&&(o.promoted=!0);break}default:{const o=i.charCodeAt(0);if(o<57)r+=o-48;else{const s=i.toLowerCase();t.set(ie([r,n]),{role:yo[s],color:i===s?"black":"white"}),++r}}}return t}function So(e){return eo.map(t=>bt.map(n=>{const r=e.get(n+t);if(r){let i=wo[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function mr(e,t){t.animation&&(fn(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function vr(e,t){var n,r,i;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),fn(e,t),t.fen&&(e.pieces=gr(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&lo(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&dr(e,e.selected),mr(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,a=e.movable.dests.get(s),l=e.pieces.get(s);if(!a||!l||l.role!=="king")return;e.movable.dests.set(s,a.filter(c=>!(c==="a"+o&&a.includes("c"+o))&&!(c==="h"+o&&a.includes("g"+o))))}}function fn(e,t){for(const n in t)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(t,n)||(Object.prototype.hasOwnProperty.call(e,n)&&Kn(e[n])&&Kn(t[n])?fn(e[n],t[n]):e[n]=t[n])}function Kn(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const Le=(e,t)=>t.animation.enabled?Co(e,t):ke(e,t);function ke(e,t){const n=e(t);return t.dom.redraw(),n}const Tt=(e,t)=>({key:e,pos:D(e),piece:t}),ko=(e,t)=>t.sort((n,r)=>rt(e.pos,n.pos)-rt(e.pos,r.pos))[0];function Eo(e,t){const n=new Map,r=[],i=new Map,o=[],s=[],a=new Map;let l,c,p;for(const[g,m]of e)a.set(g,Tt(g,m));for(const g of rn)l=t.pieces.get(g),c=a.get(g),l?c?Yt(l,c.piece)||(o.push(c),s.push(Tt(g,l))):s.push(Tt(g,l)):c&&o.push(c);for(const g of s)c=ko(g,o.filter(m=>Yt(g.piece,m.piece))),c&&(p=[c.pos[0]-g.pos[0],c.pos[1]-g.pos[1]],n.set(g.key,p.concat(p)),r.push(c.key));for(const g of o)r.includes(g.key)||i.set(g.key,g.piece);return{anims:n,fadings:i}}function br(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const i=Po(r);for(const o of n.plan.anims.values())o[2]=o[0]*i,o[3]=o[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>br(e,o))}}function Co(e,t){const n=new Map(t.pieces),r=e(t),i=Eo(n,t);if(i.anims.size||i.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},o||br(t,performance.now())}else t.dom.redraw();return r}const Po=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Ao=["green","red","blue","yellow"];function Mo(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?oe(e):un(e);const n=Fe(t),r=Be(n,Y(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:No(t),snapToValidMove:e.drawable.defaultSnapToValidMove},_r(e))}function _r(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=Be(t.pos,Y(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?_o(t.orig,t.pos,Y(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),_r(e)}})}function $o(e,t){e.drawable.current&&(e.drawable.current.pos=Fe(t))}function To(e){const t=e.drawable.current;t&&(t.mouseSq&&Io(e.drawable,t),yr(e))}function yr(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function xo(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),wr(e.drawable))}function No(e){var t;const n=(e.shiftKey||e.ctrlKey)&&tr(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Ao[(n?1:0)+(r?2:0)]}function Io(e,t){const n=i=>i.orig===t.orig&&i.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(i=>!n(i))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),wr(e)}function wr(e){e.onChange&&e.onChange(e.shapes)}function Lo(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=Fe(t),i=Be(r,Y(e),n);if(!i)return;const o=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&xo(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Oo(e,r)))t.preventDefault();else if(t.touches)return;const a=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&ln(e,e.selected,i)?Le(g=>Zt(g,i),e):Zt(e,i);const c=e.selected===i,p=kr(e,i);if(o&&p&&c&&mo(e,i)){e.draggable.current={orig:i,piece:o,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const g=e.dom.elements.ghost;g&&(g.className=`ghost ${o.color} ${o.role}`,ce(g,at(n)(D(i),Y(e))),sn(g,!0)),dn(e)}else a&&$e(e),l&&Te(e);e.dom.redraw()}function Oo(e,t){const n=Y(e),r=e.dom.bounds(),i=Math.pow(r.width/8,2);for(const o of e.pieces.keys()){const s=nr(o,n,r);if(rt(s,t)<=i)return!0}return!1}function Do(e,t,n,r){const i="a0";e.pieces.set(i,t),e.dom.redraw();const o=Fe(n);e.draggable.current={orig:i,piece:t,origPos:o,pos:o,started:!0,element:()=>kr(e,i),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},dn(e)}function dn(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(!r||!Yt(r,n.piece))yt(e);else if(!n.started&&rt(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const i=e.dom.bounds();ce(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==Be(n.pos,Y(e),i))}dn(e)})}function qo(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=Fe(t))}function Ko(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}$e(e),Te(e);const r=Fe(t)||n.pos,i=Be(r,Y(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?fr(e,n.orig,i,n.force):(e.stats.ctrlKey=t.ctrlKey,ur(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),V(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?oe(e):e.selectable.enabled||oe(e),Sr(e),e.draggable.current=void 0,e.dom.redraw()}function yt(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,oe(e),Sr(e),e.dom.redraw())}function Sr(e){const t=e.dom.elements;t.ghost&&sn(t.ghost,!1)}function kr(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Ro(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Rn(e,2),setTimeout(()=>Rn(e,void 0),120)},120)}function Rn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Fo(e,t){function n(){so(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),mr(e,r),(r.fen?Le:ke)(i=>vr(i,r),e)},state:e,getFen:()=>So(e.pieces),toggleOrientation:n,setPieces(r){Le(i=>ao(i,r),e)},selectSquare(r,i){r?Le(o=>Zt(o,r,i),e):e.selected&&(oe(e),e.dom.redraw())},move(r,i){Le(o=>lr(o,r,i),e)},newPiece(r,i){Le(o=>an(o,r,i),e)},playPremove(){if(e.premovable.current){if(Le(vo,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const i=bo(e,r);return e.dom.redraw(),i}return!1},cancelPremove(){ke($e,e)},cancelPredrop(){ke(Te,e)},cancelMove(){ke(r=>{un(r),yt(r)},e)},stop(){ke(r=>{qn(r),yt(r)},e)},explode(r){Ro(e,r)},setAutoShapes(r){ke(i=>i.drawable.autoShapes=r,e)},setShapes(r){ke(i=>i.drawable.shapes=r,e)},getKeyAtDomPos(r){return Be(r,Y(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,i,o){Do(e,r,i,o)},destroy(){qn(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Bo(){return{pieces:gr(pr),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:no()}}const Fn={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Uo(){const e=R("defs"),t=Q(R("filter"),{id:"cg-filter-blur"});return t.appendChild(Q(R("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Ho(e,t,n){var r;const i=e.drawable,o=i.current,s=o&&o.mouseSq?o:void 0,a=new Map,l=e.dom.bounds(),c=i.autoShapes.filter(y=>!y.piece);for(const y of i.shapes.concat(c).concat(s?[s]:[])){if(!y.dest)continue;const v=(r=a.get(y.dest))!==null&&r!==void 0?r:new Set,_=kt(St(D(y.orig),e.orientation),l),A=kt(St(D(y.dest),e.orientation),l);v.add(Jt(_,A)),a.set(y.dest,v)}const p=i.shapes.concat(c).map(y=>({shape:y,current:!1,hash:Bn(y,Xt(y.dest,a),!1,l)}));s&&p.push({shape:s,current:!0,hash:Bn(s,Xt(s.dest,a),!0,l)});const g=p.map(y=>y.hash).join(";");if(g===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=g;const m=t.querySelector("defs");Wo(i,p,m),jo(p,t.querySelector("g"),n.querySelector("g"),y=>zo(e,y,i.brushes,a,l))}function Wo(e,t,n){var r;const i=new Map;let o;for(const l of t.filter(c=>c.shape.dest&&c.shape.brush))o=Er(e.brushes[l.shape.brush],l.shape.modifiers),!((r=l.shape.modifiers)===null||r===void 0)&&r.hilite&&i.set(wt(o).key,wt(o)),i.set(o.key,o);const s=new Set;let a=n.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[l,c]of i.entries())s.has(l)||n.appendChild(Zo(c))}function jo(e,t,n,r){const i=new Map;for(const o of e)i.set(o.hash,!1);for(const o of[t,n]){const s=[];let a=o.firstElementChild,l;for(;a;)l=a.getAttribute("cgHash"),i.has(l)?i.set(l,!0):s.push(a),a=a.nextElementSibling;for(const c of s)o.removeChild(c)}for(const o of e.filter(s=>!i.get(s.hash)))for(const s of r(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function Bn({orig:e,dest:t,brush:n,piece:r,modifiers:i,customSvg:o,label:s},a,l,c){var p,g;return[c.width,c.height,l,e,t,n,a&&"-",r&&Go(r),i&&Qo(i),o&&`custom-${Un(o.html)},${(g=(p=o.center)===null||p===void 0?void 0:p[0])!==null&&g!==void 0?g:"o"}`,s&&`label-${Un(s.text)}`].filter(m=>m).join(",")}function Go(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Qo(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Un(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function zo(e,{shape:t,current:n,hash:r},i,o,s){var a,l;const c=kt(St(D(t.orig),e.orientation),s),p=t.dest?kt(St(D(t.dest),e.orientation),s):c,g=t.brush&&Er(i[t.brush],t.modifiers),m=o.get(t.dest),y=[];if(g){const v=Q(R("g"),{cgHash:r});y.push({el:v}),c[0]!==p[0]||c[1]!==p[1]?v.appendChild(Yo(t,g,c,p,n,Xt(t.dest,o))):v.appendChild(Vo(i[t.brush],c,n,s))}if(t.label){const v=t.label;(a=v.fill)!==null&&a!==void 0||(v.fill=t.brush&&i[t.brush].color);const _=t.brush?void 0:"tr";y.push({el:Xo(v,r,c,p,m,_),isCustom:!0})}if(t.customSvg){const v=(l=t.customSvg.center)!==null&&l!==void 0?l:"orig",[_,A]=v==="label"?Pr(c,p,m).map(L=>L-.5):v==="dest"?p:c,T=Q(R("g"),{transform:`translate(${_},${A})`,cgHash:r});T.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,y.push({el:T,isCustom:!0})}return y}function Vo(e,t,n,r){const i=Jo(),o=(r.width+r.height)/(4*Math.max(r.width,r.height));return Q(R("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:Cr(e,n),cx:t[0],cy:t[1],r:o-i[1]/2})}function wt(e){return["#ffffff","#fff","white"].includes(e.color)?Fn.hilitePrimary:Fn.hiliteWhite}function Yo(e,t,n,r,i,o){var s;function a(p){var g;const m=ts(o&&!i),y=r[0]-n[0],v=r[1]-n[1],_=Math.atan2(v,y),A=Math.cos(_)*m,T=Math.sin(_)*m;return Q(R("line"),{stroke:p?wt(t).color:t.color,"stroke-width":es(t,i)+(p?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${p?wt(t).key:t.key})`,opacity:!((g=e.modifiers)===null||g===void 0)&&g.hilite?1:Cr(t,i),x1:n[0],y1:n[1],x2:r[0]-A,y2:r[1]-T})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);const l=R("g"),c=Q(R("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(ns(n,r)),c.appendChild(a(!0)),l.appendChild(c),l.appendChild(a(!1)),l}function Zo(e){const t=Q(R("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(Q(R("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Xo(e,t,n,r,i,o){var s;const l=.4*.75**e.text.length,c=Pr(n,r,i),p=o==="tr"?.4:0,g=Q(R("g"),{transform:`translate(${c[0]+p},${c[1]-p})`,cgHash:t});g.appendChild(Q(R("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const m=Q(R("text"),{"font-size":l,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return m.innerHTML=e.text,g.appendChild(m),g}function St(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Xt(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function R(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Q(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function Er(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function Jo(){return[3/64,4/64]}function es(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Cr(e,t){return(e.opacity||1)*(t?.9:1)}function ts(e){return(e?20:10)/64}function kt(e,t){const n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function ns(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return Q(R("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function Jt(e,t,n=!0){const r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function rs(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,r)=>n+r*r,0))}function Pr(e,t,n){let r=rs(e,t);const i=Jt(e,t,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;const o=Jt(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(r-=.4)}return[e[0]-Math.cos(i)*r,e[1]-Math.sin(i)*r].map(o=>o+.5)}function is(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const l of Ji)e.classList.toggle("orientation-"+l,t.orientation===l);e.classList.toggle("manipulable",!t.viewOnly);const n=ge("cg-container");e.appendChild(n);const r=ge("cg-board");n.appendChild(r);let i,o,s;if(t.drawable.visible&&(i=Q(R("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(Uo()),i.appendChild(R("g")),o=Q(R("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(R("g")),s=ge("cg-auto-pieces"),n.appendChild(i),n.appendChild(o),n.appendChild(s)),t.coordinates){const l=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const p=t.orientation==="white"?g=>g+1:g=>8-g;bt.forEach((g,m)=>n.appendChild(xt(_t.map(y=>g+y),"squares rank"+p(m)+l+c)))}else n.appendChild(xt(_t,"ranks"+l+c)),n.appendChild(xt(bt,"files"+l))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=ge("piece","ghost"),sn(a,!1),n.appendChild(a)),{board:r,container:n,wrap:e,ghost:a,svg:i,customSvg:o,autoPieces:s}}function xt(e,t){const n=ge("coords",t);let r;for(const i of e)r=ge("coord"),r.textContent=i,n.appendChild(r);return n}function os(e,t){if(!e.dropmode.active)return;$e(e),Te(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=Fe(t),i=r&&Be(r,Y(e),e.dom.bounds());i&&fr(e,"a0",i)}e.dom.redraw()}function ss(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;const r=ls(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function as(e,t){const n=[];if("ResizeObserver"in window||n.push(Ye(document.body,"chessground.resize",t)),!e.viewOnly){const r=Hn(e,qo,$o),i=Hn(e,Ko,To);for(const s of["touchmove","mousemove"])n.push(Ye(document,s,r));for(const s of["touchend","mouseup"])n.push(Ye(document,s,i));const o=()=>e.dom.bounds.clear();n.push(Ye(document,"scroll",o,{capture:!0,passive:!0})),n.push(Ye(window,"resize",o,{passive:!0}))}return()=>n.forEach(r=>r())}function Ye(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}const ls=e=>t=>{e.draggable.current?yt(e):e.drawable.current?yr(e):t.shiftKey||tr(t)?e.drawable.enabled&&Mo(e,t):e.viewOnly||(e.dropmode.active?os(e,t):Lo(e,t))},Hn=(e,t,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)};function cs(e){const t=Y(e),n=at(e.dom.bounds()),r=e.dom.elements.board,i=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,a=o?o.plan.fadings:new Map,l=e.draggable.current,c=fs(e),p=new Set,g=new Set,m=new Map,y=new Map;let v,_,A,T,L,z,ne,Z,Ue,He;for(_=r.firstChild;_;){if(v=_.cgKey,Ar(_))if(A=i.get(v),L=s.get(v),z=a.get(v),T=_.cgPiece,_.cgDragging&&(!l||l.orig!==v)&&(_.classList.remove("dragging"),ce(_,n(D(v),t)),_.cgDragging=!1),!z&&_.cgFading&&(_.cgFading=!1,_.classList.remove("fading")),A){if(L&&_.cgAnimating&&T===Ze(A)){const N=D(v);N[0]+=L[2],N[1]+=L[3],_.classList.add("anim"),ce(_,n(N,t))}else _.cgAnimating&&(_.cgAnimating=!1,_.classList.remove("anim"),ce(_,n(D(v),t)),e.addPieceZIndex&&(_.style.zIndex=Nt(D(v),t)));T===Ze(A)&&(!z||!_.cgFading)?p.add(v):z&&T===Ze(z)?(_.classList.add("fading"),_.cgFading=!0):It(m,T,_)}else It(m,T,_);else if(Mr(_)){const N=_.className;c.get(v)===N?g.add(v):It(y,N,_)}_=_.nextSibling}for(const[N,ye]of c)if(!g.has(N)){Ue=y.get(ye),He=Ue&&Ue.pop();const j=n(D(N),t);if(He)He.cgKey=N,ce(He,j);else{const X=ge("square",ye);X.cgKey=N,ce(X,j),r.insertBefore(X,r.firstChild)}}for(const[N,ye]of i)if(L=s.get(N),!p.has(N))if(ne=m.get(Ze(ye)),Z=ne&&ne.pop(),Z){Z.cgKey=N,Z.cgFading&&(Z.classList.remove("fading"),Z.cgFading=!1);const j=D(N);e.addPieceZIndex&&(Z.style.zIndex=Nt(j,t)),L&&(Z.cgAnimating=!0,Z.classList.add("anim"),j[0]+=L[2],j[1]+=L[3]),ce(Z,n(j,t))}else{const j=Ze(ye),X=ge("piece",j),xe=D(N);X.cgPiece=j,X.cgKey=N,L&&(X.cgAnimating=!0,xe[0]+=L[2],xe[1]+=L[3]),ce(X,n(xe,t)),e.addPieceZIndex&&(X.style.zIndex=Nt(xe,t)),r.appendChild(X)}for(const N of m.values())jn(e,N);for(const N of y.values())jn(e,N)}function us(e){const t=Y(e),n=at(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Ar(r)&&!r.cgAnimating||Mr(r))&&ce(r,n(D(r.cgKey),t)),r=r.nextSibling}function Wn(e){var t,n;const r=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,o=r.height/r.width,s=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*o;i.style.width=s+"px",i.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",a+"px")}const Ar=e=>e.tagName==="PIECE",Mr=e=>e.tagName==="SQUARE";function jn(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Nt(e,t){const r=e[1];return`${t?10-r:3+r}`}const Ze=e=>`${e.color} ${e.role}`;function fs(e){var t,n,r;const i=new Map;if(e.lastMove&&e.highlight.lastMove)for(const a of e.lastMove)he(i,a,"last-move");if(e.check&&e.highlight.check&&he(i,e.check,"check"),e.selected&&(he(i,e.selected,"selected"),e.movable.showDests)){const a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(const c of a)he(i,c,"move-dest"+(e.pieces.has(c)?" oc":""));const l=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&r!==void 0?r:e.premovable.dests;if(l)for(const c of l)he(i,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}const o=e.premovable.current;if(o)for(const a of o)he(i,a,"current-premove");else e.predroppable.current&&he(i,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const a of s.keys)he(i,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,l)=>{he(i,l,a)}),i}function he(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function It(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function ds(e,t,n){const r=new Map,i=[];for(const a of e)r.set(a.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),r.has(s)?r.set(s,!0):i.push(o),o=o.nextElementSibling;for(const a of i)t.removeChild(a);for(const a of e)r.get(a.hash)||t.appendChild(n(a))}function hs(e,t){const r=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:ms(i),current:!1}));ds(r,t,i=>gs(e,i,e.dom.bounds()))}function ps(e){var t;const n=Y(e),r=at(e.dom.bounds());let i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)er(i,r(D(i.cgKey),n),i.cgScale),i=i.nextSibling}function gs(e,{shape:t,hash:n},r){var i,o,s;const a=t.orig,l=(i=t.piece)===null||i===void 0?void 0:i.role,c=(o=t.piece)===null||o===void 0?void 0:o.color,p=(s=t.piece)===null||s===void 0?void 0:s.scale,g=ge("piece",`${l} ${c}`);return g.setAttribute("cgHash",n),g.cgKey=a,g.cgScale=p,er(g,at(r)(D(a),Y(e)),p),g}const ms=e=>{var t,n,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function vs(e,t){const n=Bo();vr(n,t||{});function r(){const i="dom"in n?n.dom.unbind:void 0,o=is(e,n),s=to(()=>o.board.getBoundingClientRect()),a=p=>{cs(c),o.autoPieces&&hs(c,o.autoPieces),!p&&o.svg&&Ho(c,o.svg,o.customSvg)},l=()=>{Wn(c),us(c),o.autoPieces&&ps(c)},c=n;return c.dom={elements:o,bounds:s,redraw:bs(a),redrawNow:a,unbind:i},c.drawable.prevSvgHash="",Wn(c),a(!1),ss(c,l),i||(c.dom.unbind=as(c,l)),c.events.insert&&c.events.insert(o),c}return Fo(r(),r)}function bs(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function _s(e){return e!==null?{comment:e,variations:[]}:{variations:[]}}function ys(e,t,n,r,i){const o={move:e,variations:i};return t&&(o.suffix=t),n&&(o.nag=n),r!==null&&(o.comment=r),o}function ws(...e){const[t,...n]=e;let r=t;for(const i of n)i!==null&&(r.variations=[i,...i.variations],i.variations=[],r=i);return t}function Ss(e,t){if(t.marker&&t.marker.comment){let n=t.root;for(;;){const r=n.variations[0];if(!r){n.comment=t.marker.comment;break}n=r}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function ks(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}function Qe(e,t,n,r){var i=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Qe.prototype),i.expected=t,i.found=n,i.location=r,i.name="SyntaxError",i}ks(Qe,Error);function Lt(e,t,n){return n=n||" ",e.length>t?e:(t-=e.length,n+=n.repeat(t),e+n.slice(0,t))}Qe.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var n=null,r;for(r=0;r<e.length;r++)if(e[r].source===this.location.source){n=e[r].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,s=this.location.source+":"+o.line+":"+o.column;if(n){var a=this.location.end,l=Lt("",o.line.toString().length," "),c=n[i.line-1],p=i.line===a.line?a.column:c.length+1,g=p-i.column||1;t+=`
 --> `+s+`
`+l+` |
`+o.line+" | "+c+`
`+l+" | "+Lt("",i.column-1," ")+Lt("",g,"^")}else t+=`
 at `+s}return t};Qe.buildMessage=function(e,t){var n={literal:function(c){return'"'+i(c.text)+'"'},class:function(c){var p=c.parts.map(function(g){return Array.isArray(g)?o(g[0])+"-"+o(g[1]):o(g)});return"["+(c.inverted?"^":"")+p.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(c){return c.description}};function r(c){return c.charCodeAt(0).toString(16).toUpperCase()}function i(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+r(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+r(p)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+r(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+r(p)})}function s(c){return n[c.type](c)}function a(c){var p=c.map(s),g,m;if(p.sort(),p.length>0){for(g=1,m=1;g<p.length;g++)p[g-1]!==p[g]&&(p[m]=p[g],m++);p.length=m}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function l(c){return c?'"'+i(c)+'"':"end of input"}return"Expected "+a(e)+" but "+l(t)+" found."};function Es(e,t){t=t!==void 0?t:{};var n={},r=t.grammarSource,i={pgn:xn},o=xn,s="[",a='"',l="]",c=".",p="O-O-O",g="O-O",m="0-0-0",y="0-0",v="$",_="{",A="}",T=";",L="(",z=")",ne="1-0",Z="0-1",Ue="1/2-1/2",He="*",N=/^[a-zA-Z]/,ye=/^[^"]/,j=/^[0-9]/,X=/^[.]/,xe=/^[a-zA-Z1-8\-=]/,Zr=/^[+#]/,vn=/^[!?]/,bn=/^[^}]/,_n=/^[^\r\n]/,yn=/^[ \t\r\n]/,Xr=re("tag pair"),Jr=F("[",!1),wn=F('"',!1),ei=F("]",!1),ti=re("tag name"),Mt=le([["a","z"],["A","Z"]],!1,!1),ni=re("tag value"),Sn=le(['"'],!0,!1),ri=re("move number"),ct=le([["0","9"]],!1,!1),ii=F(".",!1),kn=le(["."],!1,!1),oi=re("standard algebraic notation"),si=F("O-O-O",!1),ai=F("O-O",!1),li=F("0-0-0",!1),ci=F("0-0",!1),En=le([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),ui=le(["+","#"],!1,!1),fi=re("suffix annotation"),Cn=le(["!","?"],!1,!1),di=re("NAG"),hi=F("$",!1),pi=re("brace comment"),gi=F("{",!1),Pn=le(["}"],!0,!1),mi=F("}",!1),vi=re("rest of line comment"),bi=F(";",!1),An=le(["\r",`
`],!0,!1),_i=re("variation"),yi=F("(",!1),wi=F(")",!1),Si=re("game termination marker"),ki=F("1-0",!1),Ei=F("0-1",!1),Ci=F("1/2-1/2",!1),Pi=F("*",!1),Ai=re("whitespace"),Mn=le([" ","	","\r",`
`],!1,!1),Mi=function(u,d){return Ss(u,d)},$i=function(u){return Object.fromEntries(u)},Ti=function(u,d){return[u,d]},xi=function(u,d){return{root:u,marker:d}},Ni=function(u,d){return ws(_s(u),...d.flat())},Ii=function(u,d,h,S,k){return ys(u,d,h,S,k)},Li=function(u){return u},Oi=function(u){return u.replace(/[\r\n]+/g," ")},Di=function(u){return u.trim()},qi=function(u){return u},Ki=function(u,d){return{result:u,comment:d}},f=t.peg$currPos|0,We=[{line:1,column:1}],ae=f,ut=t.peg$maxFailExpected||[],b=t.peg$silentFails|0,Ve;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=i[t.startRule]}function F(u,d){return{type:"literal",text:u,ignoreCase:d}}function le(u,d,h){return{type:"class",parts:u,inverted:d,ignoreCase:h}}function Ri(){return{type:"end"}}function re(u){return{type:"other",description:u}}function $n(u){var d=We[u],h;if(d)return d;if(u>=We.length)h=We.length-1;else for(h=u;!We[--h];);for(d=We[h],d={line:d.line,column:d.column};h<u;)e.charCodeAt(h)===10?(d.line++,d.column=1):d.column++,h++;return We[u]=d,d}function Tn(u,d,h){var S=$n(u),k=$n(d),x={source:r,start:{offset:u,line:S.line,column:S.column},end:{offset:d,line:k.line,column:k.column}};return x}function w(u){f<ae||(f>ae&&(ae=f,ut=[]),ut.push(u))}function Fi(u,d,h){return new Qe(Qe.buildMessage(u,d),u,d,h)}function xn(){var u,d,h;return u=f,d=Bi(),h=Wi(),u=Mi(d,h),u}function Bi(){var u,d,h;for(u=f,d=[],h=Nn();h!==n;)d.push(h),h=Nn();return h=G(),u=$i(d),u}function Nn(){var u,d,h,S,k,x,Ne;return b++,u=f,G(),e.charCodeAt(f)===91?(d=s,f++):(d=n,b===0&&w(Jr)),d!==n?(G(),h=Ui(),h!==n?(G(),e.charCodeAt(f)===34?(S=a,f++):(S=n,b===0&&w(wn)),S!==n?(k=Hi(),e.charCodeAt(f)===34?(x=a,f++):(x=n,b===0&&w(wn)),x!==n?(G(),e.charCodeAt(f)===93?(Ne=l,f++):(Ne=n,b===0&&w(ei)),Ne!==n?u=Ti(h,k):(f=u,u=n)):(f=u,u=n)):(f=u,u=n)):(f=u,u=n)):(f=u,u=n),b--,u===n&&b===0&&w(Xr),u}function Ui(){var u,d,h;if(b++,u=f,d=[],h=e.charAt(f),N.test(h)?f++:(h=n,b===0&&w(Mt)),h!==n)for(;h!==n;)d.push(h),h=e.charAt(f),N.test(h)?f++:(h=n,b===0&&w(Mt));else d=n;return d!==n?u=e.substring(u,f):u=d,b--,u===n&&(d=n,b===0&&w(ti)),u}function Hi(){var u,d,h;for(b++,u=f,d=[],h=e.charAt(f),ye.test(h)?f++:(h=n,b===0&&w(Sn));h!==n;)d.push(h),h=e.charAt(f),ye.test(h)?f++:(h=n,b===0&&w(Sn));return u=e.substring(u,f),b--,d=n,b===0&&w(ni),u}function Wi(){var u,d,h;return u=f,d=In(),G(),h=Yi(),h===n&&(h=null),G(),u=xi(d,h),u}function In(){var u,d,h,S;for(u=f,d=$t(),d===n&&(d=null),h=[],S=Ln();S!==n;)h.push(S),S=Ln();return u=Ni(d,h),u}function Ln(){var u,d,h,S,k,x,Ne,ft;if(u=f,G(),ji(),G(),d=Gi(),d!==n){for(h=Qi(),h===n&&(h=null),S=[],k=On();k!==n;)S.push(k),k=On();for(k=G(),x=$t(),x===n&&(x=null),Ne=[],ft=Dn();ft!==n;)Ne.push(ft),ft=Dn();u=Ii(d,h,S,x,Ne)}else f=u,u=n;return u}function ji(){var u,d,h,S,k,x;for(b++,u=f,d=[],h=e.charAt(f),j.test(h)?f++:(h=n,b===0&&w(ct));h!==n;)d.push(h),h=e.charAt(f),j.test(h)?f++:(h=n,b===0&&w(ct));if(e.charCodeAt(f)===46?(h=c,f++):(h=n,b===0&&w(ii)),h!==n){for(S=G(),k=[],x=e.charAt(f),X.test(x)?f++:(x=n,b===0&&w(kn));x!==n;)k.push(x),x=e.charAt(f),X.test(x)?f++:(x=n,b===0&&w(kn));d=[d,h,S,k],u=d}else f=u,u=n;return b--,u===n&&(d=n,b===0&&w(ri)),u}function Gi(){var u,d,h,S,k,x;if(b++,u=f,d=f,e.substr(f,5)===p?(h=p,f+=5):(h=n,b===0&&w(si)),h===n&&(e.substr(f,3)===g?(h=g,f+=3):(h=n,b===0&&w(ai)),h===n&&(e.substr(f,5)===m?(h=m,f+=5):(h=n,b===0&&w(li)),h===n&&(e.substr(f,3)===y?(h=y,f+=3):(h=n,b===0&&w(ci)),h===n))))if(h=f,S=e.charAt(f),N.test(S)?f++:(S=n,b===0&&w(Mt)),S!==n){if(k=[],x=e.charAt(f),xe.test(x)?f++:(x=n,b===0&&w(En)),x!==n)for(;x!==n;)k.push(x),x=e.charAt(f),xe.test(x)?f++:(x=n,b===0&&w(En));else k=n;k!==n?(S=[S,k],h=S):(f=h,h=n)}else f=h,h=n;return h!==n?(S=e.charAt(f),Zr.test(S)?f++:(S=n,b===0&&w(ui)),S===n&&(S=null),h=[h,S],d=h):(f=d,d=n),d!==n?u=e.substring(u,f):u=d,b--,u===n&&(d=n,b===0&&w(oi)),u}function Qi(){var u,d,h;for(b++,u=f,d=[],h=e.charAt(f),vn.test(h)?f++:(h=n,b===0&&w(Cn));h!==n;)d.push(h),d.length>=2?h=n:(h=e.charAt(f),vn.test(h)?f++:(h=n,b===0&&w(Cn)));return d.length<1?(f=u,u=n):u=d,b--,u===n&&(d=n,b===0&&w(fi)),u}function On(){var u,d,h,S,k;if(b++,u=f,G(),e.charCodeAt(f)===36?(d=v,f++):(d=n,b===0&&w(hi)),d!==n){if(h=f,S=[],k=e.charAt(f),j.test(k)?f++:(k=n,b===0&&w(ct)),k!==n)for(;k!==n;)S.push(k),k=e.charAt(f),j.test(k)?f++:(k=n,b===0&&w(ct));else S=n;S!==n?h=e.substring(h,f):h=S,h!==n?u=Li(h):(f=u,u=n)}else f=u,u=n;return b--,u===n&&b===0&&w(di),u}function $t(){var u;return u=zi(),u===n&&(u=Vi()),u}function zi(){var u,d,h,S,k;if(b++,u=f,e.charCodeAt(f)===123?(d=_,f++):(d=n,b===0&&w(gi)),d!==n){for(h=f,S=[],k=e.charAt(f),bn.test(k)?f++:(k=n,b===0&&w(Pn));k!==n;)S.push(k),k=e.charAt(f),bn.test(k)?f++:(k=n,b===0&&w(Pn));h=e.substring(h,f),e.charCodeAt(f)===125?(S=A,f++):(S=n,b===0&&w(mi)),S!==n?u=Oi(h):(f=u,u=n)}else f=u,u=n;return b--,u===n&&(d=n,b===0&&w(pi)),u}function Vi(){var u,d,h,S,k;if(b++,u=f,e.charCodeAt(f)===59?(d=T,f++):(d=n,b===0&&w(bi)),d!==n){for(h=f,S=[],k=e.charAt(f),_n.test(k)?f++:(k=n,b===0&&w(An));k!==n;)S.push(k),k=e.charAt(f),_n.test(k)?f++:(k=n,b===0&&w(An));h=e.substring(h,f),u=Di(h)}else f=u,u=n;return b--,u===n&&(d=n,b===0&&w(vi)),u}function Dn(){var u,d,h,S;return b++,u=f,G(),e.charCodeAt(f)===40?(d=L,f++):(d=n,b===0&&w(yi)),d!==n?(h=In(),h!==n?(G(),e.charCodeAt(f)===41?(S=z,f++):(S=n,b===0&&w(wi)),S!==n?u=qi(h):(f=u,u=n)):(f=u,u=n)):(f=u,u=n),b--,u===n&&b===0&&w(_i),u}function Yi(){var u,d,h;return b++,u=f,e.substr(f,3)===ne?(d=ne,f+=3):(d=n,b===0&&w(ki)),d===n&&(e.substr(f,3)===Z?(d=Z,f+=3):(d=n,b===0&&w(Ei)),d===n&&(e.substr(f,7)===Ue?(d=Ue,f+=7):(d=n,b===0&&w(Ci)),d===n&&(e.charCodeAt(f)===42?(d=He,f++):(d=n,b===0&&w(Pi))))),d!==n?(G(),h=$t(),h===n&&(h=null),u=Ki(d,h)):(f=u,u=n),b--,u===n&&(d=n,b===0&&w(Si)),u}function G(){var u,d;for(b++,u=[],d=e.charAt(f),yn.test(d)?f++:(d=n,b===0&&w(Mn));d!==n;)u.push(d),d=e.charAt(f),yn.test(d)?f++:(d=n,b===0&&w(Mn));return b--,d=n,b===0&&w(Ai),u}if(Ve=o(),t.peg$library)return{peg$result:Ve,peg$currPos:f,peg$FAILED:n,peg$maxFailExpected:ut,peg$maxFailPos:ae};if(Ve!==n&&f===e.length)return Ve;throw Ve!==n&&f<e.length&&w(Ri()),Fi(ut,ae<e.length?e.charAt(ae):null,ae<e.length?Tn(ae,ae+1):Tn(ae,ae))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const mt=0xffffffffffffffffn;function Ot(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function Gn(e,t){return e*t&mt}function Cs(e){return function(){let t=BigInt(e&mt),n=BigInt(e>>64n&mt);const r=Gn(Ot(Gn(t,5n),7n),9n);return n^=t,t=(Ot(t,24n)^n^n<<16n)&mt,n=Ot(n,37n),e=n<<64n|t,r}}const Et=Cs(0xa187eb39cdcaed8f31c4b365b102e01en),Ps=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>Et()))),As=Array.from({length:8},()=>Et()),Ms=Array.from({length:16},()=>Et()),Dt=Et(),W="w",J="b",q="p",en="n",vt="b",et="r",Ee="q",K="k",qt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class dt{constructor(t,n){O(this,"color");O(this,"from");O(this,"to");O(this,"piece");O(this,"captured");O(this,"promotion");O(this,"flags");O(this,"san");O(this,"lan");O(this,"before");O(this,"after");const{color:r,piece:i,from:o,to:s,flags:a,captured:l,promotion:c}=n,p=B(o),g=B(s);this.color=r,this.piece=i,this.from=p,this.to=g,this.san=t._moveToSan(n,t._moves({legal:!0})),this.lan=p+g,this.before=t.fen(),t._makeMove(n),this.after=t.fen(),t._undoMove(),this.flags="";for(const m in C)C[m]&a&&(this.flags+=Ie[m]);l&&(this.captured=l),c&&(this.promotion=c,this.lan+=c)}isCapture(){return this.flags.indexOf(Ie.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(Ie.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(Ie.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(Ie.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(Ie.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(Ie.BIG_PAWN)>-1}}const U=-1,Ie={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},tn={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},$s={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Ts={...tn,...$s},E={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Kt={b:[16,32,17,15],w:[-16,-32,-17,-15]},Qn={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},xs=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Ns=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Is={p:1,n:2,b:4,r:8,q:16,k:32},Ls="pnbrqkPNBRQK",zn=[en,vt,et,Ee],Os=7,Ds=6,qs=1,Ks=0,ht={[K]:C.KSIDE_CASTLE,[Ee]:C.QSIDE_CASTLE},we={w:[{square:E.a1,flag:C.QSIDE_CASTLE},{square:E.h1,flag:C.KSIDE_CASTLE}],b:[{square:E.a8,flag:C.QSIDE_CASTLE},{square:E.h8,flag:C.KSIDE_CASTLE}]},Rs={b:qs,w:Ds},Rt="--";function De(e){return e>>4}function it(e){return e&15}function $r(e){return"0123456789".indexOf(e)!==-1}function B(e){const t=it(e),n=De(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function Xe(e){return e===W?J:W}function Fs(e){const t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const n=parseInt(t[5],10);if(isNaN(n)||n<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const r=parseInt(t[4],10);if(isNaN(r)||r<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<i.length;s++){let a=0,l=!1;for(let c=0;c<i[s].length;c++)if($r(i[s][c])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(i[s][c],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[s][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,l=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:s,regex:a}of o){if(!a.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(i[0]+i[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Bs(e,t){const n=e.from,r=e.to,i=e.piece;let o=0,s=0,a=0;for(let l=0,c=t.length;l<c;l++){const p=t[l].from,g=t[l].to,m=t[l].piece;i===m&&n!==p&&r===g&&(o++,De(n)===De(p)&&s++,it(n)===it(p)&&a++)}return o>0?s>0&&a>0?B(n):a>0?B(n).charAt(1):B(n).charAt(0):""}function Se(e,t,n,r,i,o=void 0,s=C.NORMAL){const a=De(r);if(i===q&&(a===Os||a===Ks))for(let l=0;l<zn.length;l++){const c=zn[l];e.push({color:t,from:n,to:r,piece:i,captured:o,promotion:c,flags:s|C.PROMOTION})}else e.push({color:t,from:n,to:r,piece:i,captured:o,flags:s})}function Vn(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:q:(t=t.toLowerCase(),t==="o"?K:t)}function Ft(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Us{constructor(t=qt,{skipValidation:n=!1}={}){O(this,"_board",new Array(128));O(this,"_turn",W);O(this,"_header",{});O(this,"_kings",{w:U,b:U});O(this,"_epSquare",-1);O(this,"_halfMoves",0);O(this,"_moveNumber",0);O(this,"_history",[]);O(this,"_comments",{});O(this,"_castling",{w:0,b:0});O(this,"_hash",0n);O(this,"_positionCount",new Map);this.load(t,{skipValidation:n})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:U,b:U},this._turn=W,this._castling={w:0,b:0},this._epSquare=U,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Ts},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:n=!1,preserveHeaders:r=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const a=["-","-","0","1"];t=i.concat(a.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!n){const{ok:a,error:l}=Fs(t);if(!a)throw new Error(l)}const o=i[0];let s=0;this.clear({preserveHeaders:r});for(let a=0;a<o.length;a++){const l=o.charAt(a);if(l==="/")s+=8;else if($r(l))s+=parseInt(l,10);else{const c=l<"a"?W:J;this._put({type:l.toLowerCase(),color:c},B(s)),s++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=C.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=C.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=C.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=C.QSIDE_CASTLE),this._epSquare=i[3]==="-"?U:E[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var s,a;let n=0,r="";for(let l=E.a8;l<=E.h1;l++){if(this._board[l]){n>0&&(r+=n,n=0);const{color:c,type:p}=this._board[l];r+=c===W?p.toUpperCase():p.toLowerCase()}else n++;l+1&136&&(n>0&&(r+=n),l!==E.h1&&(r+="/"),n=0,l+=8)}let i="";this._castling[W]&C.KSIDE_CASTLE&&(i+="K"),this._castling[W]&C.QSIDE_CASTLE&&(i+="Q"),this._castling[J]&C.KSIDE_CASTLE&&(i+="k"),this._castling[J]&C.QSIDE_CASTLE&&(i+="q"),i=i||"-";let o="-";if(this._epSquare!==U)if(t)o=B(this._epSquare);else{const l=this._epSquare+(this._turn===W?16:-16),c=[l+1,l-1];for(const p of c){if(p&136)continue;const g=this._turn;if(((s=this._board[p])==null?void 0:s.color)===g&&((a=this._board[p])==null?void 0:a.type)===q){this._makeMove({color:g,from:p,to:this._epSquare,piece:q,captured:q,flags:C.EP_CAPTURE});const m=!this._isKingAttacked(g);if(this._undoMove(),m){o=B(this._epSquare);break}}}}return[r,this._turn,i,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:n,type:r}=this._board[t],i={w:0,b:1}[n],o={p:0,n:1,b:2,r:3,q:4,k:5}[r];return Ps[i][o][t]}_epKey(){return this._epSquare===U?0n:As[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return Ms[t]}_computeHash(){let t=0n;for(let n=E.a8;n<=E.h1;n++){if(n&136){n+=7;continue}this._board[n]&&(t^=this._pieceKey(n))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Dt),t}_updateSetup(t){this._history.length>0||(t!==qt?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(qt)}get(t){return this._board[E[t]]}findPiece(t){var r;const n=[];for(let i=E.a8;i<=E.h1;i++){if(i&136){i+=7;continue}!this._board[i]||((r=this._board[i])==null?void 0:r.color)!==t.color||this._board[i].color===t.color&&this._board[i].type===t.type&&n.push(B(i))}return n}put({type:t,color:n},r){return this._put({type:t,color:n},r)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,n){this._hash^=this._pieceKey(t),this._board[t]=n,this._hash^=this._pieceKey(t)}_put({type:t,color:n},r){if(Ls.indexOf(t.toLowerCase())===-1||!(r in E))return!1;const i=E[r];if(t==K&&!(this._kings[n]==U||this._kings[n]==i))return!1;const o=this._board[i];return o&&o.type===K&&(this._kings[o.color]=U),this._set(i,{type:t,color:n}),t===K&&(this._kings[n]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const n=this.get(t);return this._clear(E[t]),n&&n.type===K&&(this._kings[n.color]=U),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),n}_updateCastlingRights(){var r,i,o,s,a,l,c,p,g,m,y,v;this._hash^=this._castlingKey();const t=((r=this._board[E.e1])==null?void 0:r.type)===K&&((i=this._board[E.e1])==null?void 0:i.color)===W,n=((o=this._board[E.e8])==null?void 0:o.type)===K&&((s=this._board[E.e8])==null?void 0:s.color)===J;(!t||((a=this._board[E.a1])==null?void 0:a.type)!==et||((l=this._board[E.a1])==null?void 0:l.color)!==W)&&(this._castling.w&=-65),(!t||((c=this._board[E.h1])==null?void 0:c.type)!==et||((p=this._board[E.h1])==null?void 0:p.color)!==W)&&(this._castling.w&=-33),(!n||((g=this._board[E.a8])==null?void 0:g.type)!==et||((m=this._board[E.a8])==null?void 0:m.color)!==J)&&(this._castling.b&=-65),(!n||((y=this._board[E.h8])==null?void 0:y.type)!==et||((v=this._board[E.h8])==null?void 0:v.color)!==J)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){var o,s;if(this._epSquare===U)return;const t=this._epSquare+(this._turn===W?-16:16),n=this._epSquare+(this._turn===W?16:-16),r=[n+1,n-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((o=this._board[n])==null?void 0:o.color)!==Xe(this._turn)||((s=this._board[n])==null?void 0:s.type)!==q){this._hash^=this._epKey(),this._epSquare=U;return}const i=a=>{var l,c;return!(a&136)&&((l=this._board[a])==null?void 0:l.color)===this._turn&&((c=this._board[a])==null?void 0:c.type)===q};r.some(i)||(this._hash^=this._epKey(),this._epSquare=U)}_attacked(t,n,r){const i=[];for(let o=E.a8;o<=E.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const s=this._board[o],a=o-n;if(a===0)continue;const l=a+119;if(xs[l]&Is[s.type]){if(s.type===q){if(a>0&&s.color===W||a<=0&&s.color===J)if(r)i.push(B(o));else return!0;continue}if(s.type==="n"||s.type==="k")if(r){i.push(B(o));continue}else return!0;const c=Ns[l];let p=o+c,g=!1;for(;p!==n;){if(this._board[p]!=null){g=!0;break}p+=c}if(!g)if(r){i.push(B(o));continue}else return!0}}return r?i:!1}attackers(t,n){return n?this._attacked(n,E[t],!0):this._attacked(this._turn,E[t],!0)}_isKingAttacked(t){const n=this._kings[t];return n===-1?!1:this._attacked(Xe(t),n)}hash(){return this._hash.toString(16)}isAttacked(t,n){return this._attacked(n,E[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},n=[];let r=0,i=0;for(let o=E.a8;o<=E.h1;o++){if(i=(i+1)%2,o&136){o+=7;continue}const s=this._board[o];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===vt&&n.push(i),r++)}if(r===2)return!0;if(r===3&&(t[vt]===1||t[en]===1))return!0;if(r===t[vt]+2){let o=0;const s=n.length;for(let a=0;a<s;a++)o+=n[a];if(o===0||o===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:n=void 0,piece:r=void 0}={}){const i=this._moves({square:n,piece:r});return t?i.map(o=>new dt(this,o)):i.map(o=>this._moveToSan(o,i))}_moves({legal:t=!0,piece:n=void 0,square:r=void 0}={}){var y;const i=r?r.toLowerCase():void 0,o=n==null?void 0:n.toLowerCase(),s=[],a=this._turn,l=Xe(a);let c=E.a8,p=E.h1,g=!1;if(i)if(i in E)c=p=E[i],g=!0;else return[];for(let v=c;v<=p;v++){if(v&136){v+=7;continue}if(!this._board[v]||this._board[v].color===l)continue;const{type:_}=this._board[v];let A;if(_===q){if(o&&o!==_)continue;A=v+Kt[a][0],this._board[A]||(Se(s,a,v,A,q),A=v+Kt[a][1],Rs[a]===De(v)&&!this._board[A]&&Se(s,a,v,A,q,void 0,C.BIG_PAWN));for(let T=2;T<4;T++)A=v+Kt[a][T],!(A&136)&&(((y=this._board[A])==null?void 0:y.color)===l?Se(s,a,v,A,q,this._board[A].type,C.CAPTURE):A===this._epSquare&&Se(s,a,v,A,q,q,C.EP_CAPTURE))}else{if(o&&o!==_)continue;for(let T=0,L=Qn[_].length;T<L;T++){const z=Qn[_][T];for(A=v;A+=z,!(A&136);){if(!this._board[A])Se(s,a,v,A,_);else{if(this._board[A].color===a)break;Se(s,a,v,A,_,this._board[A].type,C.CAPTURE);break}if(_===en||_===K)break}}}}if((o===void 0||o===K)&&(!g||p===this._kings[a])){if(this._castling[a]&C.KSIDE_CASTLE){const v=this._kings[a],_=v+2;!this._board[v+1]&&!this._board[_]&&!this._attacked(l,this._kings[a])&&!this._attacked(l,v+1)&&!this._attacked(l,_)&&Se(s,a,this._kings[a],_,K,void 0,C.KSIDE_CASTLE)}if(this._castling[a]&C.QSIDE_CASTLE){const v=this._kings[a],_=v-2;!this._board[v-1]&&!this._board[v-2]&&!this._board[v-3]&&!this._attacked(l,this._kings[a])&&!this._attacked(l,v-1)&&!this._attacked(l,_)&&Se(s,a,this._kings[a],_,K,void 0,C.QSIDE_CASTLE)}}if(!t||this._kings[a]===-1)return s;const m=[];for(let v=0,_=s.length;v<_;v++)this._makeMove(s[v]),this._isKingAttacked(a)||m.push(s[v]),this._undoMove();return m}move(t,{strict:n=!1}={}){let r=null;if(typeof t=="string")r=this._moveFromSan(t,n);else if(t===null)r=this._moveFromSan(Rt,n);else if(typeof t=="object"){const o=this._moves();for(let s=0,a=o.length;s<a;s++)if(t.from===B(o[s].from)&&t.to===B(o[s].to)&&(!("promotion"in o[s])||t.promotion===o[s].promotion)){r=o[s];break}}if(!r)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&r.flags&C.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new dt(this,r);return this._makeMove(r),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,n){this._hash^=this._pieceKey(t),this._board[n]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(n)}_makeMove(t){var i,o,s,a;const n=this._turn,r=Xe(n);if(this._push(t),t.flags&C.NULL_MOVE){n===J&&this._moveNumber++,this._halfMoves++,this._turn=r,this._epSquare=U;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&C.EP_CAPTURE&&(this._turn===J?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:n})),this._board[t.to].type===K){if(this._kings[n]=t.to,t.flags&C.KSIDE_CASTLE){const l=t.to-1,c=t.to+1;this._movePiece(c,l)}else if(t.flags&C.QSIDE_CASTLE){const l=t.to+1,c=t.to-2;this._movePiece(c,l)}this._castling[n]=0}if(this._castling[n]){for(let l=0,c=we[n].length;l<c;l++)if(t.from===we[n][l].square&&this._castling[n]&we[n][l].flag){this._castling[n]^=we[n][l].flag;break}}if(this._castling[r]){for(let l=0,c=we[r].length;l<c;l++)if(t.to===we[r][l].square&&this._castling[r]&we[r][l].flag){this._castling[r]^=we[r][l].flag;break}}if(this._hash^=this._castlingKey(),t.flags&C.BIG_PAWN){let l;n===J?l=t.to-16:l=t.to+16,!(t.to-1&136)&&((i=this._board[t.to-1])==null?void 0:i.type)===q&&((o=this._board[t.to-1])==null?void 0:o.color)===r||!(t.to+1&136)&&((s=this._board[t.to+1])==null?void 0:s.type)===q&&((a=this._board[t.to+1])==null?void 0:a.color)===r?(this._epSquare=l,this._hash^=this._epKey()):this._epSquare=U}else this._epSquare=U;t.piece===q?this._halfMoves=0:t.flags&(C.CAPTURE|C.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,n===J&&this._moveNumber++,this._turn=r,this._hash^=Dt}undo(){const t=this._hash,n=this._undoMove();if(n){const r=new dt(this,n);return this._decPositionCount(t),r}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const n=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Dt;const r=this._turn,i=Xe(r);if(n.flags&C.NULL_MOVE)return n;if(this._movePiece(n.to,n.from),n.piece&&(this._clear(n.from),this._set(n.from,{type:n.piece,color:r})),n.captured)if(n.flags&C.EP_CAPTURE){let o;r===J?o=n.to-16:o=n.to+16,this._set(o,{type:q,color:i})}else this._set(n.to,{type:n.captured,color:i});if(n.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)){let o,s;n.flags&C.KSIDE_CASTLE?(o=n.to+1,s=n.to-1):(o=n.to-2,s=n.to+1),this._movePiece(s,o)}return n}pgn({newline:t=`
`,maxWidth:n=0}={}){const r=[];let i=!1;for(const m in this._header)this._header[m]&&r.push(`[${m} "${this._header[m]}"]`+t),i=!0;i&&this._history.length&&r.push(t);const o=m=>{const y=this._comments[this.fen()];if(typeof y<"u"){const v=m.length>0?" ":"";m=`${m}${v}{${y}}`}return m},s=[];for(;this._history.length>0;)s.push(this._undoMove());const a=[];let l="";for(s.length===0&&a.push(o(""));s.length>0;){l=o(l);const m=s.pop();if(!m)break;if(!this._history.length&&m.color==="b"){const y=`${this._moveNumber}. ...`;l=l?`${l} ${y}`:y}else m.color==="w"&&(l.length&&a.push(l),l=this._moveNumber+".");l=l+" "+this._moveToSan(m,this._moves({legal:!0})),this._makeMove(m)}if(l.length&&a.push(o(l)),a.push(this._header.Result||"*"),n===0)return r.join("")+a.join(" ");const c=function(){return r.length>0&&r[r.length-1]===" "?(r.pop(),!0):!1},p=function(m,y){for(const v of y.split(" "))if(v){if(m+v.length>n){for(;c();)m--;r.push(t),m=0}r.push(v),m+=v.length,r.push(" "),m++}return c()&&m--,m};let g=0;for(let m=0;m<a.length;m++){if(g+a[m].length>n&&a[m].includes("{")){g=p(g,a[m]);continue}g+a[m].length>n&&m!==0?(r[r.length-1]===" "&&r.pop(),r.push(t),g=0):m!==0&&(r.push(" "),g++),r.push(a[m]),g+=a[m].length}return r.join("")}header(...t){for(let n=0;n<t.length;n+=2)typeof t[n]=="string"&&typeof t[n+1]=="string"&&(this._header[t[n]]=t[n+1]);return this._header}setHeader(t,n){return this._header[t]=n??tn[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=tn[t]||null,!0):!1}getHeaders(){const t={};for(const[n,r]of Object.entries(this._header))r!==null&&(t[n]=r);return t}loadPgn(t,{strict:n=!1,newlineChar:r=`\r?
`}={}){r!==`\r?
`&&(t=t.replace(new RegExp(r,"g"),`
`));const i=Es(t);this.reset();const o=i.headers;let s="";for(const c in o)c.toLowerCase()==="fen"&&(s=o[c]),this.header(c,o[c]);if(!n)s&&this.load(s,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let a=i.root;for(;a;){if(a.move){const c=this._moveFromSan(a.move,n);if(c==null)throw new Error(`Invalid move in PGN: ${a.move}`);this._makeMove(c),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}const l=i.result;l&&Object.keys(this._header).length&&this._header.Result!==l&&this.setHeader("Result",l)}_moveToSan(t,n){let r="";if(t.flags&C.KSIDE_CASTLE)r="O-O";else if(t.flags&C.QSIDE_CASTLE)r="O-O-O";else{if(t.flags&C.NULL_MOVE)return Rt;if(t.piece!==q){const i=Bs(t,n);r+=t.piece.toUpperCase()+i}t.flags&(C.CAPTURE|C.EP_CAPTURE)&&(t.piece===q&&(r+=B(t.from)[0]),r+="x"),r+=B(t.to),t.promotion&&(r+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?r+="#":r+="+"),this._undoMove(),r}_moveFromSan(t,n=!1){let r=Ft(t);if(n||(r==="0-0"?r="O-O":r==="0-0-0"&&(r="O-O-O")),r==Rt)return{color:this._turn,from:0,to:0,piece:"k",flags:C.NULL_MOVE};let i=Vn(r),o=this._moves({legal:!0,piece:i});for(let m=0,y=o.length;m<y;m++)if(r===Ft(this._moveToSan(o[m],o)))return o[m];if(n)return null;let s,a,l,c,p,g=!1;if(a=r.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],l=a[2],c=a[3],p=a[4],l.length==1&&(g=!0)):(a=r.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],l=a[2],c=a[3],p=a[4],l.length==1&&(g=!0))),i=Vn(r),o=this._moves({legal:!0,piece:s||i}),!c)return null;for(let m=0,y=o.length;m<y;m++)if(l){if((!s||s.toLowerCase()==o[m].piece)&&E[l]==o[m].from&&E[c]==o[m].to&&(!p||p.toLowerCase()==o[m].promotion))return o[m];if(g){const v=B(o[m].from);if((!s||s.toLowerCase()==o[m].piece)&&E[c]==o[m].to&&(l==v[0]||l==v[1])&&(!p||p.toLowerCase()==o[m].promotion))return o[m]}}else if(r===Ft(this._moveToSan(o[m],o)).replace("x",""))return o[m];return null}ascii(){let t=`   +------------------------+
`;for(let n=E.a8;n<=E.h1;n++){if(it(n)===0&&(t+=" "+"87654321"[De(n)]+" |"),this._board[n]){const r=this._board[n].type,o=this._board[n].color===W?r.toUpperCase():r.toLowerCase();t+=" "+o+" "}else t+=" . ";n+1&136&&(t+=`|
`,n+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const n=this._moves({legal:!1});let r=0;const i=this._turn;for(let o=0,s=n.length;o<s;o++)this._makeMove(n[o]),this._isKingAttacked(i)||(t-1>0?r+=this.perft(t-1):r++),this._undoMove();return r}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let n=[];for(let r=E.a8;r<=E.h1;r++)this._board[r]==null?n.push(null):n.push({square:B(r),type:this._board[r].type,color:this._board[r].color}),r+1&136&&(t.push(n),n=[],r+=8);return t}squareColor(t){if(t in E){const n=E[t];return(De(n)+it(n))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const n=[],r=[];for(;this._history.length>0;)n.push(this._undoMove());for(;;){const i=n.pop();if(!i)break;t?r.push(new dt(this,i)):r.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return r}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const n=this._positionCount.get(t)??0;n===1?this._positionCount.delete(t):this._positionCount.set(t,n-1)}_pruneComments(){const t=[],n={},r=i=>{i in this._comments&&(n[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(r(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),r(this.fen())}this._comments=n}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const n=this._comments[t];return delete this._comments[t],{fen:t,comment:n}})}setCastlingRights(t,n){for(const i of[K,Ee])n[i]!==void 0&&(n[i]?this._castling[t]|=ht[i]:this._castling[t]&=~ht[i]);this._updateCastlingRights();const r=this.getCastlingRights(t);return(n[K]===void 0||n[K]===r[K])&&(n[Ee]===void 0||n[Ee]===r[Ee])}getCastlingRights(t){return{[K]:(this._castling[t]&ht[K])!==0,[Ee]:(this._castling[t]&ht[Ee])!==0}}moveNumber(){return this._moveNumber}}function Hs(e,t="white"){if(!e||typeof e!="string")return"https://lichess.org/analysis";const n=e.trim().split(/\s+/);if(n.length<4)return"https://lichess.org/analysis";const r=n[0],i=n[1],o=n[2],s=n[3],a=n[4]??"0",l=n[5]??"1",c=`${i} ${o} ${s} ${a} ${l}`,p=encodeURIComponent(c);return`https://lichess.org/analysis/${r}%20${p}?color=${t==="black"?"black":"white"}&engine=1`}function Ws(e){if(!e||typeof e!="string")return"https://lichess.org/analysis";const t=e.trim();if(!t)return"https://lichess.org/analysis";const n=t.split(/\r?\n\r?\n/);let r=n.length>1?n.slice(1).join(`

`):t;return r=r.replace(/{[^}]*}/g," ").replace(/;[^\n]*/g," ").replace(/\([^)]*\)/g," "),r=r.replace(/\r?\n/g," ").replace(/\s+/g," ").trim(),r=r.replace(/\s*(1-0|0-1|1\/2-1\/2|\*)\s*$/,"").trim(),r?`https://lichess.org/analysis/pgn/${r.replace(/(\d+)\.\s+/g,"$1.").replace(/\s+/g,"+")}`:"https://lichess.org/analysis"}function js({pgn:e,fen:t,orientation:n="white"}){return e&&e.trim()?Ws(e):Hs(t,n)}function Gs(e,t){const n=e[0];return t==="w"?[n+"8",n+"7",n+"6",n+"5"]:[n+"1",n+"2",n+"3",n+"4"]}function Qs(e,t){const n=hn(t,0,e.length);let r="";for(let i=0;i<e.length;i++){const o=e[i];if(i%2===0){const a=Math.floor(i/2)+1;r+=`<span class="num">${a}.</span>`}const s=i+1===n?"active":"";r+=`<span class="mv ${s}" data-ply="${i+1}">${Vs(o.san)}</span>`}return r||'<span class="num"></span>'}function Tr(e,t,n){return hn(e+t,0,n)}function zs(e,t){const n=hn(t,0,e.length);if(n>=e.length)return{newLine:e,basePly:e.length,cut:!1};const r=e.slice(0,n);return{newLine:r,basePly:r.length,cut:!0}}function hn(e,t,n){return Math.max(t,Math.min(n,e))}function Vs(e){return e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function Me(e,t){return Math.max(0,Math.min(t,e))}function xr(e,t){const n=Me(t,e.length);if(n<=0)return null;const r=e[n-1];return[r.from,r.to]}function Ys(e,t,n){return Me(t,n)}function Zs(e){const t=e.length;return{viewPly:t,lastMove:xr(e,t)}}function Xs(e,t){const n=zs(e,t);return{line:n.newLine,viewPly:n.basePly}}function Js(e){return/\[FEN\s+"/i.test(String(e??""))}function Nr({name:e,color:t}){const n=Date.now();return{id:`s_${n}_${Math.random().toString(16).slice(2)}`,name:String(e??"").trim()||"New opening",color:t==="black"?"black":"white",pgn:"",createdAt:n,updatedAt:n}}function Ct(e,t){const n=Array.isArray(e)?e.slice():[],r=n.findIndex(i=>i.id===t.id);return r===-1?[...n,t]:(n[r]={...n[r],...t},n)}function ea(e,t){return(Array.isArray(e)?e:[]).find(n=>n.id===t)??null}function ta({legacyPgn:e,existingStudies:t}){const n=Array.isArray(t)?t:[];if(n.length>0)return{studies:n,activeStudyId:n[0].id};if(!e)return{studies:[],activeStudyId:null};const r=Nr({name:"Migrated opening",color:"white"});return r.pgn=e,r.updatedAt=Date.now(),{studies:[r],activeStudyId:r.id}}function Ir(e,t){const n=t%2===0;return e==="white"?n:!n}function na(e,t){if(!e||!t||e.from!==t.from||e.to!==t.to)return!1;const n=e.promotion??null,r=t.promotion??null;return n===r}function Bt(e,t){const n=Me(t,e.length);return n>=e.length?null:e[n]??null}function ra({fullLine:e,viewPly:t,studyColor:n,makeMove:r,setGameToPly:i},o){const s=Ir(n,t),a=Bt(e,t);if(!s){try{i(t)}catch{}return null}if(a&&na(a,o)){const l=Bt(e,t+1);try{i(l?t+2:t+1)}catch{try{i(t)}catch{}return null}return!0}if(t===e.length){const l=r(o);if(!l){try{i(t)}catch{}return null}const c=Bt(e,t+1);if(c)try{r({from:c.from,to:c.to,promotion:c.promotion})}catch{}return l}try{i(t)}catch{}return null}const Lr="blunderlab.pgn",pn="blunderlab.orientation",Or="blunderlab.studies.v1",Dr="blunderlab.activeStudyId",lt=document.getElementById("board"),qr=document.getElementById("undoBtn"),Kr=document.getElementById("redoBtn"),ia=document.getElementById("flipBtn"),Ut=document.getElementById("copyPgnBtn"),oa=document.getElementById("lichessBtn"),de=document.getElementById("fenLine"),Rr=document.getElementById("pgn"),Yn=document.getElementById("pgnInput"),Ht=document.getElementById("btnImportPgn"),Wt=document.getElementById("studiesBtn"),fe=document.getElementById("overlay"),jt=document.getElementById("closeOverlayBtn"),Gt=document.getElementById("newStudyBtn"),Qt=document.getElementById("studyList"),ve=document.getElementById("newStudyForm"),tt=document.getElementById("newStudyName"),Ce=document.getElementById("pickWhite"),Pe=document.getElementById("pickBlack"),zt=document.getElementById("cancelNewStudy"),Je=document.getElementById("modeToggleBtn"),P=new Us;let be=localStorage.getItem(pn)||"white",I=[],$=0,ze="",Pt="white",pe=null,ot=new Map,H=[],te=null,pt=null,ee="edit",ue=0,gt=0,Vt=0;const st=300;if(Je){Je.innerHTML="",Je.classList.add("segmented-toggle");const e=document.createElement("button");e.type="button",e.className="iconbtn",e.textContent="Edit",e.setAttribute("aria-pressed","false");const t=document.createElement("button");t.type="button",t.className="iconbtn",t.textContent="Train",t.setAttribute("aria-pressed","false");const n=()=>{ee==="train"?(t.classList.add("active"),t.setAttribute("aria-pressed","true"),e.classList.remove("active"),e.setAttribute("aria-pressed","false")):(e.classList.add("active"),e.setAttribute("aria-pressed","true"),t.classList.remove("active"),t.setAttribute("aria-pressed","false"))};e.addEventListener("click",()=>{ee!=="edit"&&(ee="edit",n(),nn(),me({save:!1}))}),t.addEventListener("click",()=>{if(ee!=="train"){ee="train",n();try{se(0),Vr({delayMs:500})}catch{}}}),Je.appendChild(e),Je.appendChild(t),n()}function sa(){try{const e=localStorage.getItem(Or);return e?JSON.parse(e):[]}catch(e){return console.warn("Failed to parse studies:",e),[]}}function Ke(){try{localStorage.setItem(Or,JSON.stringify(H)),te&&localStorage.setItem(Dr,te)}catch(e){console.warn("Failed to save studies:",e)}}function Re(){return ea(H,te)}function Fr(){const e=Re();if(!e){try{localStorage.setItem(Lr,ze)}catch(r){console.warn("Auto-save PGN failed:",r)}return}const t=Date.now(),n={...e,pgn:ze,updatedAt:t};H=Ct(H,n),Ke()}function gn(e){const t=new Map,n=e.moves({verbose:!0});for(const r of n)t.has(r.from)||t.set(r.from,[]),t.get(r.from).push(r.to);return t}function Ae(e){const t=Me(e,I.length);P.reset();try{for(let n=0;n<t;n++){const r=I[n];P.move({from:r.from,to:r.to,promotion:r.promotion})}}catch{P.reset()}}function Zn(e,t){const n=P.get(e);if(!n||n.type!=="p")return!1;const r=t[1];return n.color==="w"&&r==="8"||n.color==="b"&&r==="1"}function aa(e){return e==="w"?"white":"black"}function la(e){const t=(e??"").trim();if(!t||Js(t))return!1;const n=P.pgn();try{P.reset(),P.loadPgn(t)}catch{P.reset();try{P.loadPgn(n)}catch{}return Ae($),me({save:!0}),!1}return _e(),se(I.length,{save:!0}),!0}function Br(e){const t=e.color==="black"?"black":"white";be=t;try{localStorage.setItem(pn,t)}catch{}me({save:!1})}function ca(){const e=lt.querySelector(".cg-wrap");if(e&&!e.querySelector(".promo-dimmer")){const t=document.createElement("div");t.className="promo-dimmer",e.appendChild(t)}}function Xn(e,t){var o;const n=P.get(e).color,r=Gs(t,n);pe={from:e,to:t,squares:r};const i=aa(n);M.setPieces(new Map([[r[0],{role:"queen",color:i}],[r[1],{role:"knight",color:i}],[r[2],{role:"rook",color:i}],[r[3],{role:"bishop",color:i}]])),ot=new Map(r.map(s=>[s,"promo"])),M.set({movable:{free:!1,color:void 0,dests:new Map},highlight:{check:!0,lastMove:!0,custom:ot}}),(o=lt.querySelector(".cg-wrap"))==null||o.classList.add("promo-active")}function nt(){var i;if(!pe)return;const[e,t,n,r]=pe.squares;M.setPieces(new Map([[e,null],[t,null],[n,null],[r,null]])),pe=null,ot=new Map,(i=lt.querySelector(".cg-wrap"))==null||i.classList.remove("promo-active")}function Ur(){qr.disabled=$<=0,Kr.disabled=$>=I.length}function Hr(){Rr.innerHTML=Qs(I,$)}function Wr(){return xr(I,$)}function me({save:e=!0}={}){var i;const t=P.turn()==="w"?"white":"black",r=((i=P.inCheck)==null?void 0:i.call(P))??!1?t:!1;M.set({fen:P.fen(),orientation:be,turnColor:t,movable:{free:!1,color:t,dests:gn(P)},check:r,highlight:{check:!0,lastMove:!0,custom:ot},lastMove:Wr()??void 0}),de.value=P.fen(),de.classList.remove("invalid"),Hr(),Ur(),e&&$===I.length&&Fr()}function Oe({save:e=!0}={}){var i;const t=P.turn()==="w"?"white":"black",r=((i=P.inCheck)==null?void 0:i.call(P))??!1?t:!1;M.set({orientation:be,turnColor:t,movable:{free:!1,color:t,dests:gn(P)},check:r,highlight:{check:!0,lastMove:!0,custom:ot},lastMove:Wr()??void 0}),de.value=P.fen(),de.classList.remove("invalid"),Hr(),Ur(),e&&$===I.length&&Fr()}function je(){if(!Qt)return;const e=H.slice().sort((t,n)=>(n.updatedAt??0)-(t.updatedAt??0));Qt.innerHTML="";for(const t of e){const n=document.createElement("div");n.className="study-item";const r=document.createElement("div");if(r.className="study-meta",pt===t.id){const l=document.createElement("input");l.className="study-rename input-box",l.type="text",l.value=t.name,setTimeout(()=>l.focus(),0);const c=()=>{const g=l.value.trim();if(pt=null,!g||g===t.name){je();return}const m={...t,name:g,updatedAt:Date.now()};H=Ct(H,m),Ke(),je()},p=()=>{pt=null,je()};l.addEventListener("keydown",g=>{g.key==="Enter"&&c(),g.key==="Escape"&&p()}),l.addEventListener("blur",c),r.appendChild(l)}else{const l=document.createElement("div");l.className="study-name",l.textContent=t.name;const c=document.createElement("div");c.className="study-sub",c.textContent=`${t.color==="black"?"Black":"White"}${t.id===te?"  active":""}`,r.appendChild(l),r.appendChild(c)}const i=document.createElement("div");i.style.display="flex",i.style.gap="8px";const o=document.createElement("button");o.className="iconbtn",o.type="button",o.title="Rename",o.textContent="",o.addEventListener("click",()=>{pt=t.id,je()}),i.appendChild(o);const s=document.createElement("button");s.className="iconbtn",s.type="button",s.title="Open",s.textContent="",s.addEventListener("click",()=>{jr(t.id),At()});const a=document.createElement("button");a.className="iconbtn",a.type="button",a.title="Delete",a.textContent="",a.addEventListener("click",()=>{window.confirm(`Delete opening: "${t.name}"?`)&&(ua(t.id),je())}),i.appendChild(s),i.appendChild(a),n.appendChild(r),n.appendChild(i),Qt.appendChild(n)}}function mn(){fe&&(fe.classList.remove("hidden"),fe.setAttribute("aria-hidden","false"),je())}function At(){fe&&(fe.classList.add("hidden"),fe.setAttribute("aria-hidden","true"))}function jr(e){const t=Re();t&&(H=Ct(H,{...t,pgn:ze,updatedAt:Date.now()})),te=e,Ke();const n=Re();if(n){if(Br(n),P.reset(),n.pgn)try{P.loadPgn(n.pgn)}catch(r){console.warn("Study PGN invalid, resetting:",r),P.reset()}_e(),se(I.length,{save:!1})}}function ua(e){var t;if(H=H.filter(n=>n.id!==e),te===e){te=((t=H[0])==null?void 0:t.id)??null,Ke(),te?jr(te):(P.reset(),_e(),se(0,{save:!1}),mn());return}Ke()}function fa(){Pt="white",Ce==null||Ce.classList.add("active"),Pe==null||Pe.classList.remove("active"),ve==null||ve.classList.remove("hidden"),tt.value="",tt==null||tt.focus()}function Gr(){ve==null||ve.classList.add("hidden")}Ce==null||Ce.addEventListener("click",()=>{Pt="white",Ce.classList.add("active"),Pe.classList.remove("active")});Pe==null||Pe.addEventListener("click",()=>{Pt="black",Pe.classList.add("active"),Ce.classList.remove("active")});zt==null||zt.addEventListener("click",Gr);Gt==null||Gt.addEventListener("click",fa);ve==null||ve.addEventListener("submit",e=>{e.preventDefault();const t=(tt.value||"").trim();if(!t)return;const n=Nr({name:t,color:Pt});H=Ct(H,n),te=n.id,Ke(),P.reset(),_e(),se(0,{save:!1}),Br(n),Gr(),At()});function se(e,{save:t=!1}={}){$=Me(e,I.length),Ae($),me({save:t})}function Qr(){ee!=="train"&&se(Tr($,-1,I.length))}function zr(){ee!=="train"&&se(Tr($,1,I.length))}let Ge=null;function nn(){Ge&&(clearTimeout(Ge),Ge=null)}function Vr({delayMs:e=350}={}){var o,s,a;if(nn(),ee!=="train")return;const t=((o=Re())==null?void 0:o.color)??"white",n=()=>{var l,c,p,g;try{if(ee!=="train"||Ir(t,$))return;const m=I[$];if(!m)return;if(typeof M<"u"&&M&&!m.promotion){let A=st;try{const ne=Date.now();A=ue&&ue>ne?ue-ne:st,ue=0,A>0?setTimeout(()=>M.move(m.from,m.to),A):M.move(m.from,m.to)}catch{se($+1,{save:!1})}const T=A;T>0?setTimeout(()=>{$=Me($+1,I.length)},T):$=Me($+1,I.length);const L=(c=(l=M==null?void 0:M.state)==null?void 0:l.animation)!=null&&c.duration?M.state.animation.duration:200,z=Math.max(e,L+60)+A;Ge=setTimeout(()=>{if(ee==="train"){try{P.move({from:m.from,to:m.to,promotion:m.promotion})}catch{Ae($)}Oe({save:!1}),n()}},z);return}se($+1,{save:!1});const v=typeof M<"u"&&((g=(p=M==null?void 0:M.state)==null?void 0:p.animation)!=null&&g.duration)?M.state.animation.duration:200,_=Math.max(e,v+60);Ge=setTimeout(n,_)}catch(m){console.error("autoplayUntilUsersTurn step error:",m),nn()}},r=typeof M<"u"&&((a=(s=M==null?void 0:M.state)==null?void 0:s.animation)!=null&&a.duration)?M.state.animation.duration:200,i=Math.max(e,r+60);Ge=setTimeout(n,i)}function _e(){I=P.history({verbose:!0}),ze=P.pgn(),$=Zs(I).viewPly}function Yr(){nt();const e=de.value.trim().replace(/\s+/g," ");if(!e)return;let t=!1;try{P.load(e),t=!0}catch{}if(!t)try{P.load(e,{sloppy:!0}),t=!0}catch{}if(!t){de.classList.add("invalid"),console.warn("FEN invalid:",e);return}de.classList.remove("invalid"),_e(),se(I.length,{save:!0})}const da=e=>{var o,s;const t=Me(e,I.length),n=$;if(t===n)return;const r=(s=(o=M==null?void 0:M.state)==null?void 0:o.animation)!=null&&s.duration?M.state.animation.duration:200,i=60;if(t===n+1){$=t,Ae($),setTimeout(()=>{Oe({save:!1})},r+i),ue=Date.now()+r+st,Vr({delayMs:500});return}if(t===n+2){const a=I[n+1];Ae(n+1);const l=P.fen();Ae(t),$=t;try{M.set({fen:l,orientation:be,turnColor:P.turn()==="w"?"white":"black"})}catch{Oe({save:!1})}const c=r+st;setTimeout(()=>{try{a.promotion||M.move(a.from,a.to)}catch{}setTimeout(()=>{Oe({save:!1})},r+i)},c);return}$=t,Ae($),Oe({save:!1})},M=vs(lt,{fen:P.fen(),orientation:be,highlight:{check:!0,lastMove:!0},movable:{free:!1,color:P.turn()==="w"?"white":"black",dests:gn(P)},events:{move:(e,t)=>{var i;if(pe)return;if(ee==="train"){if(Zn(e,t)){Xn(e,t);return}const o={from:e,to:t},s=`${o.from}-${o.to}`;let a=!1;const l=c=>{var _,A;let p=null;try{p=P.move(c)}catch{return null}if(!p)return null;_e();const g=`${c.from}-${c.to}`,m=(A=(_=M==null?void 0:M.state)==null?void 0:_.animation)!=null&&A.duration?M.state.animation.duration:200,y=60,v=st;if(!a&&g===s)a=!0,setTimeout(()=>{Oe({save:!0})},m+y),ue=Date.now()+m+v,gt=Date.now(),Vt=m;else{const T=Date.now();let L;const z=gt?gt+Vt+v:0;a&&g!==s&&z>T?L=z-T:L=ue&&ue>T?ue-T:v,ue=0,gt=0,Vt=0,setTimeout(()=>{try{M.move(c.from,c.to)}catch{}},L),setTimeout(()=>{Oe({save:!0})},L+m+y)}return p};ra({fullLine:I,viewPly:$,studyColor:((i=Re())==null?void 0:i.color)??"white",makeMove:l,setGameToPly:da},o);return}const n=Xs(I,$);if(n.line.length!==I.length&&(I=n.line,$=n.viewPly,Ae($)),Zn(e,t)){Xn(e,t);return}if(!P.move({from:e,to:t})){me({save:!1});return}_e(),me({save:!0})},select:e=>{if(!pe)return;const t=pe.squares.indexOf(e);if(t===-1)return;const n=["q","n","r","b"][t],r=P.move({from:pe.from,to:pe.to,promotion:n});if(nt(),!r){me({save:!1});return}_e(),me({save:!0})}}});requestAnimationFrame(ca);requestAnimationFrame(()=>{const e=lt.querySelector(".cg-wrap");if(!e)return;let t=null;e.addEventListener("pointerdown",()=>{e.classList.add("cg-no-trans"),t&&clearTimeout(t),t=setTimeout(()=>{e.classList.remove("cg-no-trans"),t=null},120)})});qr.addEventListener("click",Qr);Kr.addEventListener("click",zr);ia.addEventListener("click",()=>{be=be==="white"?"black":"white",localStorage.setItem(pn,be),me({save:!1})});oa.addEventListener("click",()=>{const e=js({pgn:ze,fen:P.fen(),orientation:be});window.open(e,"_blank","noopener,noreferrer")});function ha(e){if(!e)return"";const t=e.split(/\r?\n\r?\n/);return t.length>1?t.slice(1).join(`

`).trim():e.trim()}Ut.addEventListener("click",async()=>{const e=ze||P.pgn(),t=ha(e);try{await navigator.clipboard.writeText(t),Ut.textContent="",setTimeout(()=>Ut.textContent="Export PGN",800)}catch{window.prompt("Copy PGN (Ctrl+C):",t)}});Rr.addEventListener("click",e=>{if(ee==="train")return;const t=e.target.closest(".mv");if(!t)return;const n=parseInt(t.dataset.ply,10),r=Ys($,n,I.length);se(r,{save:!1})});document.addEventListener("keydown",e=>{var n;if(ee==="train")return;const t=(n=document.activeElement)==null?void 0:n.tagName;t==="INPUT"||t==="TEXTAREA"||(e.key==="ArrowLeft"&&(e.preventDefault(),Qr()),e.key==="ArrowRight"&&(e.preventDefault(),zr()))});de.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),Yr(),de.blur())});de.addEventListener("blur",Yr);Ht==null||Ht.addEventListener("click",()=>{nt==null||nt();const e=la(Yn.value);Yn.classList.toggle("invalid",!e)});Wt==null||Wt.addEventListener("click",mn);jt==null||jt.addEventListener("click",At);fe==null||fe.addEventListener("click",e=>{e.target===fe&&At()});(function(){H=sa(),te=localStorage.getItem(Dr);const t=localStorage.getItem(Lr),n=ta({legacyPgn:t,existingStudies:H});H=n.studies,te||(te=n.activeStudyId),Ke();const r=Re();if(r!=null&&r.pgn)try{P.loadPgn(r.pgn)}catch(i){console.warn("Failed to load active study PGN:",i),P.reset()}else P.reset();_e(),se(I.length,{save:!1}),Re()||mn()})();
